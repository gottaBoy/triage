# L4 自动驾驶数据闭环与 Triage 系统完整实施方案

本方案基于《L4自动驾驶数据闭环实战》系列七篇文章的核心思想进行深度解析与架构设计。旨在构建一套从“组织目标定义”到“物理AI基础设施”的端到端闭环系统。

## 总体架构图谱

系统围绕 **Data-Driven** (数据驱动) 与 **Model-Centric** (模型为中心) 的双轮驱动，通过七个关键步骤实现从发现问题到解决问题的自动化闭环。

---

## 详细实施步骤 (按系列文章顺序)

### 1. 顶层指标设计 (Loss Function)
**对应文章**: *【实战01】最重要的第一步：选对整个组织的LossFunction*

**核心目标**: 确立牵引整个研发团队（感知、预测、规划、控制）的统一“损失函数”，避免局部优化导致的整体性能下降。

*   **实施方案**:
    *   **定义北极星指标 (North Star Metric)**:
        *   **MPI (Miles Per Intervention)**: 平均接管里程，衡量系统整体成熟度。
        *   **Safety Critical Events**: 零容忍的安全事故/未遂事故率。
    *   **定义过程指标 (Proxy Metrics)**:
        *   **感知**: 漏检率 (FN)、误检率 (FP)、关键目标 IoU、远距离检测精度。
        *   **预测**: 轨迹预测误差 (ADE/FDE)、意图预测准确率。
        *   **PNC**: 急刹率 (Hard Brake Rate)、急转率、舒适度评分 (Jerk)、通行效率 (Trip Time)。
    *   **组织对齐**: 将上述指标拆解到每个 Feature Team 的 OKR 中，确保所有代码提交 (PR) 都必须通过这些指标的回归测试。

### 2. 车端数据基座 (Onboard Logging & Heartbeat)
**对应文章**: *【实战02】一级指标需要什么样的数据：L4 无人车的实时打点与业务心跳*

**核心目标**: 在车端有限的计算资源下，精准记录“发生了什么”以及“系统是否健康”。

*   **实施方案**:
    *   **实时打点系统 (Real-time Logging)**:
        *   **高频状态流**: 记录车辆位姿、速度、控制指令、模块状态机 (10Hz-100Hz)。
        *   **结构化日志**: 使用 Protobuf/Flatbuffers 定义日志格式，确保序列化效率与向后兼容。
    *   **业务心跳 (Business Heartbeat)**:
        *   **硬件监控**: 传感器 (Lidar/Camera) 丢帧、延迟、温度；计算单元 (GPU/CPU) 负载、内存。
        *   **软件监控**: 进程存活、关键线程延迟 (Latency)、模块间通信 (IPC) 延时。
        *   **告警机制**: 异常发生时，车端 HMI 报警并打上 Tag，供后续分析。

### 3. 数据传输与映射 (Ingestion & Mapping)
**对应文章**: *【实战03】自动驾驶数据闭环的“地基工程”：数据分级上传与Case逻辑映射设计*

**核心目标**: 解决海量车端数据与有限回传带宽的矛盾，建立“事件”与“数据”的逻辑关联。

*   **实施方案**:
    *   **数据分级策略 (Tiered Data Strategy)**:
        *   **Hot Data (4G/5G)**: 碰撞、接管、严重故障。立即上传，优先级最高。
        *   **Warm Data (Wi-Fi)**: 用户反馈 (User Report)、特定 Trigger 事件、高价值场景。回场站后上传。
        *   **Cold Data (Disk)**: 全量传感器原始数据 (Raw Data)。通过物理硬盘回收，用于冷存储或特定回溯。
    *   **Case 逻辑映射**:
        *   **Clip 生成**: 当 Trigger 触发时，自动截取前后 N 秒 (e.g., -30s ~ +10s) 的数据片段。
        *   **元数据关联**: 将 Clip 与车辆 ID、软件版本、地图位置、天气信息绑定，生成唯一的 Case ID。

### 4. 云端标签中枢 (Label Hub: FreeDM to FastDM)
**对应文章**: *【实战04】云端标签中枢：从 FreeDM 到 FastDM 的秒级特征空间*

**核心目标**: 让非结构化的二进制数据变成可被秒级检索的结构化特征数据库。

*   **实施方案**:
    *   **FreeDM (自由数据挖掘)**:
        *   对上传的数据进行离线大模型处理，提取语义特征 (e.g., "Construction Zone", "Jaywalking").
    *   **FastDM (快速数据管理)**:
        *   **特征工程**: 建立包含数千维度的特征向量库 (场景标签、物体属性、行为特征)。
        *   **倒排索引**: 构建类似 Elasticsearch 的检索引擎，支持 SQL-like 查询 (e.g., `SELECT * FROM clips WHERE weather='rain' AND object='pedestrian' AND action='cut_in'`).
        *   **秒级响应**: 确保算法工程师能在秒级时间内找到所需的 Corner Case 数据集。

### 5. 智能分诊系统 (Unified Trigger & Triage)
**对应文章**: *【实战05】三端统一 Trigger 框架：让异常事件自动“长成”问题单*

**核心目标**: 统一车端、云端、仿真端的异常检测逻辑，实现问题处理的自动化。

*   **实施方案**:
    *   **三端统一 Trigger**:
        *   **定义**: 使用统一的 DSL (领域特定语言) 定义 Trigger 规则 (e.g., `obs_distance < 2m AND ego_speed > 30kph`).
        *   **部署**: 同一套规则可编译部署到车端 (实时检测)、云端 (离线挖掘)、仿真 (评测)。
    *   **自动建单 (Auto-Ticketing)**:
        *   **去重 (De-duplication)**: 基于时空信息和场景相似度，合并重复上报的问题。
        *   **路由 (Routing)**: 根据 Trigger 归属 (e.g., "Lidar_Fault" -> 硬件组, "Planner_Timeout" -> 规划组) 自动指派 Jira 单。
        *   **预分析**: 自动附带相关日志链接、地图位置、以及初步的归因分析报告。

### 6. 闭环迭代 (Loop: Clustering to Training)
**对应文章**: *【实战06】典型问题场景闭环：从问题聚类到主动挖数、训练与多层验证*

**核心目标**: 将“一个问题”转化为“一类问题的解决”，彻底根治长尾场景。

*   **实施方案**:
    *   **问题聚类 (Clustering)**:
        *   利用无监督学习对未解决的 Case 进行聚类，发现共性问题 (e.g., "所有隧道出口处的误刹车")。
    *   **主动挖数 (Active Mining)**:
        *   基于聚类出的特征，在 FastDM 中主动挖掘历史海量数据中的相似场景。
    *   **训练与验证 (Train & Val)**:
        *   **数据集增强**: 将挖掘出的数据送入标注，加入训练集。
        *   **模型重训**: 触发自动化训练流水线 (MLOps)。
        *   **多层验证**:
            1.  **Model Eval**: 离线指标测试。
            2.  **Log Replay**: 历史数据开环回放。
            3.  **World Sim**: 虚拟场景闭环测试。

### 7. 基础设施展望 (Infrastructure)
**对应文章**: *【总结与展望】模型 × 数据：面向物理 AI 时代的数据基础设施*

**核心目标**: 构建适应“端到端大模型”时代的新一代基础设施。

*   **实施方案**:
    *   **Data-Centric AI**: 从“调模型结构”转向“调数据质量”。建设高质量的数据清洗、自动标注 (Auto-Labeling) 流水线。
    *   **World Model**: 构建高保真的世界模型，不仅用于仿真，更用于生成式数据扩增 (Generative AI for Data Augmentation)。
    *   **算力底座**: 建设云端大规模 GPU 集群，支持千亿参数模型的训练与大规模并发仿真。

---

## 总结

这七个步骤构成了一个严密的飞轮：
1.  **Loss Function** 指引方向。
2.  **Onboard** 采集数据。
3.  **Ingestion** 传输数据。
4.  **Label Hub** 索引数据。
5.  **Triage** 发现问题。
6.  **Loop** 解决问题并挖掘同类。
7.  **Infrastructure** 支撑整个循环的高效运转。

通过实施此方案，自动驾驶团队将从“被动修 Bug”转变为“主动通过数据迭代模型”，最终实现 L4 级别的无人驾驶能力。
