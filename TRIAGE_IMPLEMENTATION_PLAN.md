# L4 自动驾驶 Triage 系统与数据闭环实现方案

基于 `README.md` 中列出的实战系列文章标题，本方案旨在构建一个从车载端到云端，再到模型训练的完整自动驾驶数据闭环（Data Loop）与问题分诊（Triage）系统。

## 核心架构概览

本系统分为五个核心阶段，对应数据流转的生命周期：
1.  **定义 (Definition)**: 确立核心指标 (Loss Function)。
2.  **感知与采集 (Onboard)**: 车端实时打点、心跳监测与触发器 (Trigger)。
3.  **传输与管理 (Ingestion)**: 数据分级上传、Case 映射与云端标签化。
4.  **分诊与分析 (Triage & Analysis)**: 自动化问题单生成、聚类与根因分析。
5.  **闭环与迭代 (Loop)**: 数据挖掘、模型训练与验证。

---

## 详细实现步骤

### 第一阶段：顶层设计与指标定义 (Loss Function)
**目标**: 确立驱动整个组织优化的核心指标，确保技术迭代方向正确。

1.  **定义核心指标 (North Star Metrics)**:
    *   **MPI (Miles Per Intervention)**: 接管里程间隔，衡量系统成熟度。
    *   **MPR (Miles Per Report)**: 问题报告里程间隔。
    *   **关键场景成功率**: 针对特定场景（如无保护左转、施工区域）的通过率。
2.  **设计拆解指标 (L1/L2 Metrics)**:
    *   感知模块：漏检率、误检率、IoU。
    *   预测模块：轨迹预测误差 (ADE/FDE)。
    *   规划控制：急刹次数、舒适度评分、横向/纵向误差。

### 第二阶段：车端基础设施 (Onboard Infrastructure)
**目标**: 在资源受限的车端环境中，精准捕获有效数据。

1.  **实时打点系统 (Real-time Logging)**:
    *   **实现**: 开发轻量级日志库 (C++/Rust)，支持高频写入。
    *   **内容**: 记录模块状态、关键变量、时间戳、车辆位置。
2.  **业务心跳 (Business Heartbeat)**:
    *   **监控**: 监控各传感器 (Lidar, Camera, GPS) 及计算单元 (GPU/CPU) 的健康状态。
    *   **告警**: 异常发生时立即生成告警信号。
3.  **三端统一 Trigger 框架 (车端部分)**:
    *   **规则引擎**: 部署可配置的规则（如 `hard_brake > 0.5g`, `planner_fail_timeout`）。
    *   **模型触发**: 部署轻量级模型检测异常场景（如“鬼探头”检测）。
    *   **Buffer 机制**: 维护 Ring Buffer，确保能回溯记录 Trigger 发生前几十秒的数据。

### 第三阶段：数据传输与云端管理 (Data Ingestion & Management)
**目标**: 解决海量数据与有限带宽的矛盾，实现数据结构化。

1.  **数据分级上传 (Tiered Upload)**:
    *   **Level 0 (Critical)**: 接管事件、碰撞风险、严重系统故障。立即上传 (4G/5G)。
    *   **Level 1 (High Priority)**: 用户反馈、特定 Trigger 事件。站点 Wi-Fi 上传。
    *   **Level 2 (Background)**: 随机抽样、全量低频数据。物理硬盘回收或闲时上传。
2.  **Case 逻辑映射 (Case Mapping)**:
    *   将车端的 Trigger 事件映射为云端的 "Case" 对象。
    *   关联数据片段 (Bag/Log)、地图位置、软件版本信息。
3.  **云端标签中枢 (Label Hub - FreeDM to FastDM)**:
    *   **元数据提取**: 自动解析上传的数据，提取时间、地点、天气、障碍物类型等元数据。
    *   **秒级特征索引**: 构建倒排索引，支持类似 "Find all left turns with pedestrians in rain" 的秒级查询。

### 第四阶段：自动化分诊系统 (Automated Triage)
**目标**: 减少人工介入，让异常自动转化为可追踪的问题单。

1.  **三端统一 Trigger 框架 (云端部分)**:
    *   **二次清洗**: 在云端利用更强大的算力对车端上传的 Trigger 进行校验（剔除误报）。
    *   **仿真重放**: 自动在仿真环境中回放数据，确认是否为算法缺陷。
2.  **自动建单 (Auto-Ticketing)**:
    *   对接 Jira/Lark 等项目管理工具。
    *   **自动路由**: 根据 Trigger 类型自动分配给对应模块（感知、预测、PNC）。
    *   **去重机制**: 相同地点、相同类型的重复问题自动合并。
3.  **问题聚类 (Clustering)**:
    *   利用 NLP 技术分析日志，或利用场景特征向量，将相似问题聚类（如“特定路口的红绿灯识别错误”）。

### 第五阶段：闭环迭代 (Closed Loop)
**目标**: 从问题中挖掘价值，反哺模型。

1.  **主动挖数 (Active Mining)**:
    *   基于已知问题的特征，在海量未标注数据中挖掘相似场景（"Find similar"）。
2.  **数据集管理与训练**:
    *   将挖掘出的数据送入标注流水线。
    *   更新训练数据集，触发模型重训。
3.  **多层验证 (Multi-stage Validation)**:
    *   **模型评估**: 离线测试集指标验证。
    *   **Log Sim**: 使用历史 Log 进行开环仿真。
    *   **World Sim**: 在虚拟世界中进行闭环仿真。
    *   **实车灰度**: 小规模部署验证。

---

## 实施路线图 (Roadmap)

1.  **Month 1-2**: 搭建基础日志与上传通道，定义核心 Loss Function。
2.  **Month 3-4**: 实现车端 Trigger 框架，打通自动建单流程 (MVP)。
3.  **Month 5-6**: 构建云端标签系统，实现数据分级与检索。
4.  **Month 7+**: 引入聚类分析与主动挖掘，完成数据闭环自动化。
